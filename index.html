<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Mode - Live GPS Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Driver View -->
    <div id="driver-view" class="bg-gray-800 text-white flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-sm bg-gray-900 rounded-2xl shadow-xl p-8 text-center">
            <h1 class="text-3xl font-bold text-yellow-400 mb-6">Driver Mode</h1>
            
            <!-- Bus ID Section -->
            <div class="mb-6">
                <label for="bus-id-input" class="block text-sm font-semibold text-gray-300 mb-2">Enter Your Bus ID</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="bus-id-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="e.g., BUS-123">
                    <button id="save-bus-id-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">Save</button>
                </div>
                 <button id="clear-bus-id-btn" class="hidden mt-2 text-xs text-red-400 hover:text-red-300 underline">Change ID</button>
            </div>

            <!-- Status and Controls -->
            <div id="controls-section" class="hidden">
                 <p class="text-gray-400 mb-4">Tracking ID: <strong id="display-bus-id" class="text-yellow-400"></strong></p>
                <div class="bg-gray-700 rounded-lg p-4 mb-6">
                    <p class="text-sm font-semibold text-gray-300">STATUS</p>
                    <p id="driver-status" class="text-xl font-bold text-gray-300">Ready</p>
                </div>
                <div class="space-y-4">
                    <button id="start-btn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 px-6 rounded-lg transition disabled:bg-gray-500">Start Broadcasting</button>
                    <button id="end-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 px-6 rounded-lg transition disabled:bg-gray-500" disabled>End Trip</button>
                </div>
                 <button id="rules-btn" class="mt-6 text-sm text-blue-400 hover:text-blue-300 underline">View Rules</button>
            </div>
            
            <p id="error-message" class="text-red-400 mt-4 text-sm h-4"></p>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 text-white rounded-2xl shadow-xl p-8 max-w-sm w-full">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4 text-center">Driver Rules</h2>
            <ul class="space-y-3 text-gray-300 text-left list-disc list-inside">
                <li>Enter your assigned Bus ID and press 'Save'.</li>
                <li>Press <strong>'Start Broadcasting'</strong> at the beginning of your trip.</li>
                <li>Press <strong>'End Trip'</strong> only when the trip is fully completed.</li>
                <li>Keep this page open in your browser during the entire trip.</li>
                <li>Ensure your phone's GPS/Location is turned on and permission is granted.</li>
            </ul>
            <button id="close-rules-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg transition">Got It</button>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ============== PASTE YOUR FIREBASE CONFIG HERE ==============
        const firebaseConfig = {
          apiKey: "AIzaSyCISwXAdb9w44Wsa2caXbP9XPyQ3U-Yhl4",
          authDomain: "new-gps-bus.firebaseapp.com",
          projectId: "new-gps-bus",
          storageBucket: "new-gps-bus.firebasestorage.app",
          messagingSenderId: "993768802913",
          appId: "1:993768802913:web:5420a64038b6682b273820",
          measurementId: "G-06RLW2QNT6"
        };
        // =============================================================

        // --- Global Variables ---
        let busId = null;
        let db, auth;
        let watchId = null;

        // --- UI Elements ---
        const driverStatus = document.getElementById('driver-status');
        const startBtn = document.getElementById('start-btn');
        const endBtn = document.getElementById('end-btn');
        const errorMessage = document.getElementById('error-message');
        const rulesBtn = document.getElementById('rules-btn');
        const rulesModal = document.getElementById('rules-modal');
        const closeRulesBtn = document.getElementById('close-rules-btn');
        const busIdInput = document.getElementById('bus-id-input');
        const saveBusIdBtn = document.getElementById('save-bus-id-btn');
        const clearBusIdBtn = document.getElementById('clear-bus-id-btn');
        const controlsSection = document.getElementById('controls-section');
        const displayBusId = document.getElementById('display-bus-id');

        // --- App Initialization ---
        async function initializeDriverApp() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                console.log("Firebase Authenticated Anonymously.");
                
                // Check for saved Bus ID
                const savedBusId = localStorage.getItem('busId');
                if (savedBusId) {
                    busId = savedBusId;
                    busIdInput.value = busId;
                    showControls();
                }

            } catch (error) {
                console.error("CRITICAL: Firebase Init or Auth Failed!", error);
                errorMessage.textContent = "Could not connect to the service.";
            }
        }
        
        function showControls() {
            busIdInput.disabled = true;
            saveBusIdBtn.classList.add('hidden');
            clearBusIdBtn.classList.remove('hidden');
            controlsSection.classList.remove('hidden');
            displayBusId.textContent = busId;
            errorMessage.textContent = '';
        }

        function hideControls() {
            busIdInput.disabled = false;
            busIdInput.value = '';
            saveBusIdBtn.classList.remove('hidden');
            clearBusIdBtn.classList.add('hidden');
            controlsSection.classList.add('hidden');
            localStorage.removeItem('busId');
            busId = null;
        }

        // --- Event Listeners ---
        saveBusIdBtn.addEventListener('click', () => {
            const enteredId = busIdInput.value.trim().toUpperCase();
            if (enteredId) {
                busId = enteredId;
                localStorage.setItem('busId', busId);
                showControls();
            } else {
                errorMessage.textContent = 'Please enter a valid Bus ID.';
            }
        });

        clearBusIdBtn.addEventListener('click', () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                driverStatus.textContent = 'Ready';
                startBtn.disabled = false;
                endBtn.disabled = true;
            }
            hideControls();
        });


        startBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                errorMessage.textContent = 'Geolocation not supported by your browser.';
                return;
            }
            const options = { enableHighAccuracy: true };
            watchId = navigator.geolocation.watchPosition(updateLocationInFirestore, handleLocationError, options);
            driverStatus.textContent = 'Acquiring Location...';
            startBtn.disabled = true;
            endBtn.disabled = false;
        });

        endBtn.addEventListener('click', async () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            driverStatus.textContent = 'Trip Ended';
            startBtn.disabled = false;
            endBtn.disabled = true;
            try {
                await setDoc(doc(db, "buses", busId), { status: 'offline', lastUpdate: serverTimestamp() }, { merge: true });
                console.log("Trip status set to offline.");
            } catch (error) {
                console.error("Error ending trip:", error);
                errorMessage.textContent = "Failed to update trip status.";
            }
        });

        async function updateLocationInFirestore(position) {
            const { latitude, longitude } = position.coords;
            driverStatus.textContent = 'Broadcasting...';
            errorMessage.textContent = ""; // Clear previous errors
            try {
                const busRef = doc(db, "buses", busId);
                await setDoc(busRef, {
                    lat: latitude,
                    lng: longitude,
                    status: 'en-route',
                    lastUpdate: serverTimestamp()
                }, { merge: true });
                console.log("Location updated:", { latitude, longitude });
            } catch (error) {
                console.error("Firestore Write Error:", error);
                driverStatus.textContent = 'Update Failed';
                errorMessage.textContent = "Could not send location data.";
            }
        }

        function handleLocationError(error) {
            console.error("Geolocation Error:", error.message);
            driverStatus.textContent = 'Location Error';
            errorMessage.textContent = `Geolocation error: ${error.message}`;
            if(error.code === 1) { // PERMISSION_DENIED
                 if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                startBtn.disabled = true;
                endBtn.disabled = true;
            }
        }
        
        rulesBtn.addEventListener('click', () => {
            rulesModal.classList.remove('hidden');
        });

        closeRulesBtn.addEventListener('click', () => {
            rulesModal.classList.add('hidden');
        });

        // --- Start the app ---
        initializeDriverApp();

    </script>
</body>
</html>

